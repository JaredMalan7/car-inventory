@page "/inventory"
@using CarInventory.Models
@using CarInventory.Services
@using CarInventory.Components
@inject CarInventory.Services.AuthService Auth
@inject CarInventory.Data.AppDbContext Db
@inject NavigationManager Nav

<h3>Car Inventory</h3>

<!-- Search component used to filter cars by make or model -->
<InventorySearch Cars="Cars" ResultsChanged="UpdateResults" />

<!-- Button to navigate to the Add Car page -->
<button class="btn btn-primary" @onclick="AddCar">
    Add New Car
</button>

<!-- Inventory table -->
<table class="table table-striped mt-3">
    <thead>
        <tr>
            <th>Make</th>
            <th>Model</th>
            <th>Year</th>
            <th>Price</th>
            <th></th>
            <th></th>
        </tr>
    </thead>

    <tbody>
        @foreach (var car in FilteredCars)
        {
            <tr>
                <td>@car.Make</td>
                <td>@car.Model</td>
                <td>@car.Year</td>


                <td>@car.Price.ToString("C")</td>

                <!-- Action buttons -->
                <td>
                    <button class="btn btn-sm btn-info" @onclick="() => EditCar(car.Id)">
                        Edit
                    </button>

                    <button class="btn btn-sm btn-danger" @onclick="() => Delete(car.Id)">
                        Delete
                    </button>
                </td>

                <!-- Thumbnail image if available -->
                <td>
                    @if (!string.IsNullOrEmpty(car.ImageFileName))
                    {
                        <img src="@($"images/{car.ImageFileName}")" style="width:80px;" />
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@code {

    // Full list of cars loaded from the database
    private List<Car> Cars = new();

    // List used for displaying filtered results
    private List<Car> FilteredCars = new();

    // Runs when the page loads
    protected override void OnInitialized()
    {
        // Redirect unauthenticated users to the login page
        if (!Auth.IsLoggedIn)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        // Load cars from the database
        Cars = Db.Cars.ToList();

        // Initially show all cars
        FilteredCars = Cars;
    }

    // Navigate to Add Car page
    void AddCar() => Nav.NavigateTo("/addcar");

    // Navigate to Edit Car page
    void EditCar(int id) => Nav.NavigateTo($"/editcar/{id}");

    // Delete a car from the database
    void Delete(int id)
    {
        var car = Db.Cars.FirstOrDefault(c => c.Id == id);
        if (car != null)
        {
            Db.Cars.Remove(car);
            Db.SaveChanges();
        }

        // Refresh car list after deletion
        Cars = Db.Cars.ToList();
        FilteredCars = Cars;
    }

    /*
    * NOTE:
    * The code below was originally intended for additional filtering
    * and sorting features (year, price, model).
    * Due to time constraints, it was intentionally disabled.
    */

    @*
    private IEnumerable<Car> FilteredCars =>
        Cars.Where(c =>
            (string.IsNullOrWhiteSpace(searchText) ||
             c.Make.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             c.Model.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            && (string.IsNullOrWhiteSpace(yearFilter) ||
                c.Year.ToString() == yearFilter)
        );

    private IEnumerable<Car> SortedCars =>
        sortOption switch
        {
            "price" => FilteredCars.OrderBy(c => c.Price),
            "model" => FilteredCars.OrderBy(c => c.Model),
            "year" => FilteredCars.OrderBy(c => c.Year),
            _ => FilteredCars
        };
    *@

    // Receives filtered results from the InventorySearch component
    private void UpdateResults(List<Car> results)
    {
        FilteredCars = results;
        StateHasChanged();
    }
}