@page "/addcar"
@using CarInventory.Models
@using CarInventory.Services
@inject CarService CarService
@inject NavigationManager Nav
@inject VehicleLookupService VehicleLookupService

<div class="container mt-4" style="max-width: 720px;">
    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="mb-3">Add New Car</h3>

            <EditForm Model="@car" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <label class="form-label">Make</label>
                <select class="form-select mb-3" @bind="car.Make">
                    <option value="">Select Make</option>
                    @foreach (var make in Makes)
                    {
                        <option value="@make">@make</option>
                    }
                </select>

                <label class="form-label">Model</label>
                <InputText class="form-control mb-3" @bind-Value="car.Model" placeholder="Model" />

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Year</label>
                        <InputNumber class="form-control mb-3" @bind-Value="car.Year" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Price</label>
                        <InputNumber class="form-control mb-3" @bind-Value="car.Price" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label d-block">Car Image</label>
                    <label class="btn btn-outline-secondary btn-sm">
                        Choose Image
                        <InputFile OnChange="HandleImageUpload" style="display:none" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(imagePreview))
                {
                    <div class="mt-3">
                        <img src="@imagePreview" class="img-thumbnail" style="max-width:200px;" />
                    </div>
                }

                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-success px-4" type="submit">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private Car car = new();
    private IBrowserFile? selectedImage;
    private string? imagePreview;
    private List<string> Makes = new();

    protected override async Task OnInitializedAsync()
    {
        Makes = await VehicleLookupService.GetPassengerCarMakesAsync();
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        selectedImage = e.File;

        var imagesDir = Path.Combine(
        Directory.GetCurrentDirectory(),
        "wwwroot",
        "images"
        );

        Directory.CreateDirectory(imagesDir);

        var filePath = Path.Combine(imagesDir, selectedImage.Name);

        var buffer = new byte[selectedImage.Size];
        using var stream = selectedImage.OpenReadStream();
        await stream.ReadAsync(buffer);

        await File.WriteAllBytesAsync(filePath, buffer);

        car.ImageFileName = selectedImage.Name;
        imagePreview = $"images/{selectedImage.Name}";
    }

    private void HandleSubmit()
    {
        CarService.AddCar(car);
        Nav.NavigateTo("/inventory");
    }
}